#!/bin/bash
DEPLOYDIR=/home/pi/dragon_dev/app

GIT_WORK_TREE="$DEPLOYDIR" git checkout -f
echo "ğŸ—„  Checked out Repo"

while read oldrev newrev refname; do
    if [ "$refname" = "refs/heads/master" ]; then
        if git diff-tree --name-only -r -z $oldrev $newrev | grep --quiet "package-lock.json";
          then PACKAGES_CHANGED=true
          else PACKAGES_CHANGED=false
        fi
    fi
done

cd "$DEPLOYDIR"

if [[ "$PACKAGES_CHANGED" = true ]]
  then
    echo "ğŸ“¦ âš ï¸ package-lock.json Changed - Updating Packages"
    npm ci --production --no-audit
    echo "ğŸ“¦  Packages Updated  âœ…"
  else
    echo "ğŸ“¦  package-lock.json Identical - skipping  âœ…"
fi

echo "ğŸŒ€  Restarting Dragon"

tmux send-keys -t dragon_dev C-c
tmux send-keys -t dragon_dev '/home/pi/dragon_dev/start' Enter

echo "ğŸŒ€  Dragon Restarted  âœ…"
